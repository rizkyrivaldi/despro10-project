#include <HardwareSerial.h>
HardwareSerial sim(1);
String data_in;
char data;

// String head0 = "POST " + serverPath + " HTTP/1.1\r\n" + "Host: " + serverName + "\r\n";
String content_param = "multipart/form-data; boundary=ThisIsABoundary ";
String head = "--ThisIsABoundary\\r\\nContent-Disposition: form-data; name=\"imageFile\"; filename=\"esp32-cam.jpg\"\\r\\nContent-Type: image/jpeg\\r\\n\\r\\n";
String tail = "\\r\\n--ThisIsABoundary--\\r\\n";
String url = "http://desprokel10.ddns.net:1234/upload.php";

byte picture[] = {
  0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,
  0x00, 0x06, 0x04, 0x04, 0x04, 0x05, 0x04, 0x06, 0x05, 0x05, 0x06, 0x09,
  0x06, 0x05, 0x06, 0x09, 0x0B, 0x08, 0x06, 0x06, 0x08, 0x0B, 0x0C, 0x0A,
  0x0A, 0x0B, 0x0A, 0x0A, 0x0C, 0x10, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
  0x10, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
  0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
  0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0xFF, 0xDB, 0x00, 0x43, 0x01, 0x07, 0x07,
  0x07, 0x0D, 0x0C, 0x0D, 0x18, 0x10, 0x10, 0x18, 0x14, 0x0E, 0x0E, 0x0E,
  0x14, 0x14, 0x0E, 0x0E, 0x0E, 0x0E, 0x14, 0x11, 0x0C, 0x0C, 0x0C, 0x0C,
  0x0C, 0x11, 0x11, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x11, 0x0C, 0x0C,
  0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
  0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
  0x0C, 0x0C, 0xFF, 0xC0, 0x00, 0x11, 0x08, 0x00, 0x08, 0x00, 0x08, 0x03,
  0x01, 0x11, 0x00, 0x02, 0x11, 0x01, 0x03, 0x11, 0x01, 0xFF, 0xC4, 0x00,
  0x14, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0xFF, 0xC4, 0x00, 0x20, 0x10,
  0x00, 0x01, 0x03, 0x03, 0x05, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x03, 0x02, 0x04, 0x12, 0x05, 0x06, 0x14, 0x01,
  0x13, 0x16, 0x23, 0x24, 0x26, 0xFF, 0xC4, 0x00, 0x14, 0x01, 0x01, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xFF, 0xC4, 0x00, 0x14, 0x11, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0xFF, 0xDA, 0x00, 0x0C, 0x03, 0x01, 0x00, 0x02, 0x11, 0x03, 0x11,
  0x00, 0x3F, 0x00, 0x55, 0x6B, 0x1A, 0xEA, 0xB6, 0x31, 0x4B, 0x99, 0xC5,
  0x68, 0x07, 0x9F, 0xAE, 0xA8, 0xD4, 0xC3, 0xA3, 0xA2, 0x12, 0xD3, 0xB5,
  0xBE, 0x3D, 0x38, 0x4D, 0xE4, 0x55, 0xC5, 0x1E, 0x5B, 0x33, 0x75, 0xC1,
  0x10, 0xBF, 0xA2, 0x57, 0x62, 0xC3, 0xFF, 0xD9
};

void setup() {
  Serial.begin(115200);
  // sim.begin(9600, SERIAL_8N1, 16, 17); //RX TX
  sim.begin(9600, SERIAL_8N1, 12, 13); //RX TX
}

void loop() {
  while (Serial.available()) {
    data_in = Serial.readString();
    if(data_in == "sendpicture"){
      sendPicture();
    }
    else if(data_in == "inithttp"){
      initHTTP();
    }
    else{
      sim.println(data_in);
      Serial.println("Data Sent: " + data_in);
    }

  }
  // sim.println("AT");

  while (sim.available()){
    Serial.write(sim.read());
  }
}

/*
AT+SAPBR=3,1,"Contype","GPRS"
AT+CSTT="byu","",""
AT+SAPBR=1,1
AT+HTTPINIT
AT+HTTPPARA="CID",1
AT+HTTPPARA="URL","http://miliohm.com/miliohmSIM800L.php"
AT+HTTPACTION=0
AT+HTTPREAD
*/

void sendPicture(){
  Serial.println("Sending picture...");

  // sim.println("AT+HTTPPARA=URL," + url);
  response();

  // Set HTTP content header
  delay(100);
  // Set data length
  int datalen = sizeof(head) + sizeof(tail) + sizeof(picture);

  sim.println("AT+HTTPPARA=\"CONTENT\",\"" + content_param + "Content-Length: " + String(datalen) + "\"");
  response();
  delay(100);

  
  
  // Serial.println("Data Sent: AT+HTTPDATA=" + String(datalen) + ",120000\n\n");
  // Serial.println("Packet size: " + String(datalen));
  delay(100);
  sim.println("AT+HTTPDATA=" + String(datalen) + ",120000");
  sim.println("AT");
  delay(100);

  Serial.println("Printing header...");
  sim.print(head);
  // uint8_t *fbBuf = picture;
  // size_t fbLen = sizeof(picture);
  // for (size_t n=0; n<fbLen; n=n+1024) {
  //   if (n+1024 < fbLen) {
  //     sim.write(fbBuf, 1024);
  //     fbBuf += 1024;
  //   }
  //   else if (fbLen%1024>0) {
  //     size_t remainder = fbLen%1024;
  //     sim.write(fbBuf, remainder);
  //   }
  //   Serial.println("Buffer number:" + String(n));
  // }   
  for(int i = 0; i < datalen; i++){
    sim.write(picture[i]);
  }
  Serial.println("Printing tail...");
  sim.print(tail);
  sim.println();
  Serial.println("End of upload");
}

void initHTTP(){
  sim.println("AT+SAPBR=3,1,\"Contype\",\"GPRS\"");
  response();
  sim.println("AT+CSTT=\"byu\",\"\",\"\"");
  response();
  sim.println("AT+SAPBR=1,1");
  response();
  sim.println("AT+HTTPINIT");
  response();
  sim.println("AT+HTTPPARA=\"CID\",1");
  response();
}

void response(){
  while(sim.available()){
    Serial.write(sim.read());
  }
}